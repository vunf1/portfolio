name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - README.md
      - DEPLOYMENT.md
      - deploy.ps1
      # - .github/workflows/**
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          
      - name: Install dependencies
        run: npm ci
        
      - name: Type check
        run: npm run type-check
        
      - name: Lint
        run: npm run lint
        
      - name: Run tests
        run: npm run test:coverage
        
      - name: Security audit
        run: npm run security:audit
        continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build for production
        run: npm run build:gh-pages
        env:
          NODE_ENV: production
          # GitHub Pages base path - repository name (e.g., '/portfolio/')
          # This ensures assets are loaded from the correct path on GitHub Pages
          VITE_BASE_PATH: /${{ github.event.repository.name }}/
          # n8n Webhook Integration - Required for contact form
          # These secrets must be configured in GitHub repository settings:
          # Settings > Secrets and variables > Actions > New repository secret
          # Add: VITE_N8N_WEBHOOK_URL and VITE_N8N_AUTH_TOKEN
          VITE_N8N_WEBHOOK_URL: ${{ secrets.VITE_N8N_WEBHOOK_URL }}
          VITE_N8N_AUTH_TOKEN: ${{ secrets.VITE_N8N_AUTH_TOKEN }}
          
      - name: Verify dist folder exists
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ ERROR: dist folder was not created!"
            exit 1
          fi
          echo "âœ… dist folder exists"
          
      - name: Verify base path in build
        run: |
          echo "ğŸ” Verifying base path in built index.html..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ ERROR: dist/index.html not found!"
            exit 1
          fi
          if grep -q "/${{ github.event.repository.name }}/assets" dist/index.html; then
            echo "âœ… Base path correctly applied in index.html"
          else
            echo "âŒ Base path NOT found in index.html!"
            echo "ğŸ“„ First 50 lines of index.html:"
            head -50 dist/index.html
            echo ""
            echo "ğŸ” Searching for script tags:"
            grep -i "script.*src" dist/index.html || echo "No script tags found!"
            exit 1
          fi
          
      - name: Copy 404.html to dist
        run: |
          if [ -f "404.html" ]; then
            cp 404.html dist/
            echo "âœ… 404.html copied to dist/"
          else
            echo "âš ï¸ 404.html not found, skipping..."
          fi
        
      - name: Verify dist contents
        run: |
          echo "ğŸ“ Dist folder structure:"
          find dist -type f | head -20
          echo ""
          echo "ğŸ“ Dist folder contents:"
          ls -la dist/ || echo "âš ï¸ dist folder is empty or inaccessible"
          echo ""
          if [ -d "dist/assets" ]; then
            echo "ğŸ“¦ Assets folder contents:"
            ls -la dist/assets/ | head -10
          else
            echo "âš ï¸ dist/assets folder not found"
          fi
          echo ""
          if [ -d "dist/img" ]; then
            echo "ğŸ–¼ï¸ Images folder contents:"
            ls -la dist/img/ | head -10
          else
            echo "âš ï¸ dist/img folder not found"
          fi
          echo ""
          if [ -d "dist/data" ]; then
            echo "ğŸ“Š Data folder contents:"
            ls -la dist/data/ | head -10
          else
            echo "âš ï¸ dist/data folder not found"
          fi
          echo ""
          echo "ğŸ“„ Root files in dist:"
          ls -la dist/*.html dist/*.xml dist/*.txt dist/*.headers 2>/dev/null || echo "No root files found"
          echo ""
          echo "ğŸ” Script tags in index.html:"
          grep -i "script.*src" dist/index.html || echo "No script tags found!"
          echo ""
          echo "ğŸ“Š Dist folder size:"
          du -sh dist/
          echo ""
          echo "âœ… Dist folder verification complete"
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "dist"
          retention-days: 1

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment status
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ Your site is now available at: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ“¦ Deployed files from dist folder:"
          echo "  âœ… index.html"
          echo "  âœ… assets/ (JS, CSS, fonts)"
          echo "  âœ… img/ (profile, background)"
          echo "  âœ… data/ (portfolio data)"
          echo "  âœ… 404.html (SPA routing)"
          echo "  âœ… sitemap.xml (if present)"
          echo "  âœ… robots.txt (if present)"
          echo "  âœ… _headers (security, if present)"
          echo ""
          echo "ğŸ¨ Component System:"
          echo "  âœ… Design tokens"
          echo "  âœ… UI components"
          echo "  âœ… Optimized production build"
          echo ""
          echo "â±ï¸  Note: It may take a few minutes for changes to appear on GitHub Pages."
