name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - README.md
      - DEPLOYMENT.md
      - deploy.ps1
      # - .github/workflows/**
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          
      - name: Install dependencies
        run: npm ci
        
      - name: Type check
        run: npm run type-check
        
      - name: Lint
        run: npm run lint
        
      - name: Run tests
        run: npm run test:coverage
        
      - name: Security audit
        run: npm run security:audit || true
        continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: pages-deployment
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build for production
        run: npm run build:gh-pages
        env:
          NODE_ENV: production
          # GitHub Pages base path - repository name (e.g., '/portfolio/')
          # This ensures assets are loaded from the correct path on GitHub Pages
          VITE_BASE_PATH: /${{ github.event.repository.name }}/
          # EmailJS - Required for contact form (VITE_EMAILJS_PUBLIC_KEY, VITE_EMAILJS_SERVICE_ID, VITE_EMAILJS_TEMPLATE_ID)
          # Configure at: Settings > Secrets and variables > Actions (or pages-deployment environment)
          
      - name: Verify dist folder exists
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ ERROR: dist folder was not created!"
            exit 1
          fi
          echo "âœ… dist folder exists"
          
      - name: Verify base path in build
        run: |
          echo "ğŸ” Verifying base path in built index.html..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ ERROR: dist/index.html not found!"
            exit 1
          fi
          if grep -q "/${{ github.event.repository.name }}/assets" dist/index.html; then
            echo "âœ… Base path correctly applied in index.html"
          else
            echo "âŒ Base path NOT found in index.html!"
            echo "ğŸ“„ First 50 lines of index.html:"
            head -50 dist/index.html
            echo ""
            echo "ğŸ” Searching for script tags:"
            grep -i "script.*src" dist/index.html || echo "No script tags found!"
            exit 1
          fi
          
      - name: Copy 404.html to dist
        run: |
          if [ -f "404.html" ]; then
            cp 404.html dist/
            echo "âœ… 404.html copied to dist/"
          else
            echo "âš ï¸ 404.html not found, skipping..."
          fi
          
      - name: Ensure .nojekyll exists in dist
        run: |
          if [ ! -f "dist/.nojekyll" ]; then
            echo "# This file tells GitHub Pages to not process files with Jekyll" > dist/.nojekyll
            echo "# It's needed for SPAs and other non-Jekyll sites" >> dist/.nojekyll
            echo "âœ… Created .nojekyll in dist/"
          else
            echo "âœ… .nojekyll already exists in dist/"
          fi
        
      - name: Verify dist contents
        run: |
          echo "ğŸ“ Dist folder structure:"
          find dist -type f | head -20
          echo ""
          echo "ğŸ“ Dist folder contents:"
          ls -la dist/ || echo "âš ï¸ dist folder is empty or inaccessible"
          echo ""
          if [ -d "dist/assets" ]; then
            echo "ğŸ“¦ Assets folder contents:"
            ls -la dist/assets/ | head -10
          else
            echo "âš ï¸ dist/assets folder not found"
          fi
          echo ""
          if [ -d "dist/img" ]; then
            echo "ğŸ–¼ï¸ Images folder contents:"
            ls -la dist/img/ | head -10
          else
            echo "âš ï¸ dist/img folder not found"
          fi
          echo ""
          if [ -d "dist/data" ]; then
            echo "ğŸ“Š Data folder contents:"
            ls -la dist/data/ | head -10
          else
            echo "âš ï¸ dist/data folder not found"
          fi
          echo ""
          echo "ğŸ“„ Root files in dist:"
          ls -la dist/*.html dist/*.xml dist/*.txt dist/*.headers 2>/dev/null || echo "No root files found"
          echo ""
          echo "ğŸ” Script tags in index.html:"
          grep -i "script.*src" dist/index.html || echo "No script tags found!"
          echo ""
          echo "âš ï¸  CRITICAL: Verifying index.html does NOT contain development script..."
          if grep -q "src/main.tsx" dist/index.html; then
            echo "âŒ ERROR: dist/index.html contains development script tag (src/main.tsx)!"
            echo "   This means the build process failed or the wrong file was used."
            echo "   The built index.html should reference /assets/main-*.js, not src/main.tsx"
            exit 1
          else
            echo "âœ… Verified: index.html does NOT contain development script tag"
          fi
          echo ""
          echo "ğŸ“Š Dist folder size:"
          du -sh dist/
          echo ""
          echo "âœ… Dist folder verification complete"
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Clean up old artifacts (if any)
        run: |
          echo "ğŸ§¹ Checking for old 'github-pages' artifacts in this workflow run..."
          echo "ğŸ“Š Workflow Run ID: ${{ github.run_id }}"
          echo ""
          
          # Get all artifacts in current run
          ARTIFACTS_JSON=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts 2>/dev/null || echo '{"artifacts":[]}')
          ARTIFACT_IDS=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name == "github-pages") | .id' 2>/dev/null || echo "")
          
          if [ -z "$ARTIFACT_IDS" ]; then
            echo "âœ… No 'github-pages' artifacts found in this run"
          else
            echo "âš ï¸  Found existing 'github-pages' artifacts in this run:"
            echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name == "github-pages") | "  - ID: \(.id), Created: \(.created_at)"' 2>/dev/null || echo "  (Could not parse artifact details)"
            echo ""
            echo "ğŸ—‘ï¸  Deleting existing artifacts..."
            
            DELETED_COUNT=0
            for artifact_id in $ARTIFACT_IDS; do
              if [ -n "$artifact_id" ]; then
                echo "  Deleting artifact ID: $artifact_id"
                if gh api repos/${{ github.repository }}/actions/artifacts/$artifact_id -X DELETE 2>/dev/null; then
                  echo "    âœ… Successfully deleted"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                else
                  echo "    âš ï¸  Could not delete (may already be deleted)"
                fi
              fi
            done
            
            echo ""
            echo "âœ… Deleted $DELETED_COUNT artifact(s)"
            
            # Wait for deletion to propagate
            echo "â³ Waiting for deletion to propagate..."
            sleep 3
            
            # Verify cleanup worked
            REMAINING_JSON=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts 2>/dev/null || echo '{"artifacts":[]}')
            REMAINING_COUNT=$(echo "$REMAINING_JSON" | jq '[.artifacts[] | select(.name == "github-pages")] | length' 2>/dev/null || echo "0")
            
            if [ "$REMAINING_COUNT" -gt "0" ]; then
              echo "âš ï¸  WARNING: $REMAINING_COUNT artifact(s) still remain after cleanup"
              echo "   Remaining artifacts:"
              echo "$REMAINING_JSON" | jq -r '.artifacts[] | select(.name == "github-pages") | "  - ID: \(.id)"' 2>/dev/null || echo "  (Could not parse)"
              echo ""
              echo "   This may cause deployment issues. Retrying cleanup..."
              # Retry deletion
              for artifact_id in $(echo "$REMAINING_JSON" | jq -r '.artifacts[] | select(.name == "github-pages") | .id' 2>/dev/null); do
                if [ -n "$artifact_id" ]; then
                  gh api repos/${{ github.repository }}/actions/artifacts/$artifact_id -X DELETE 2>/dev/null || true
                fi
              done
              sleep 2
            else
              echo "âœ… Verified: No 'github-pages' artifacts remain in this run"
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "dist"
          retention-days: 1

  deploy:
    environment:
      name: pages-deployment
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Clean up old artifacts from previous runs
        run: |
          echo "ğŸ§¹ Cleaning up old 'github-pages' artifacts from previous workflow runs..."
          echo "ğŸ“Š Current Workflow Run ID: ${{ github.run_id }}"
          echo ""
          
          # Get current run's artifacts first
          CURRENT_RUN_ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --jq '.artifacts[] | select(.name == "github-pages") | .id' 2>/dev/null || echo "")
          CURRENT_ARTIFACT_IDS=$(echo "$CURRENT_RUN_ARTIFACTS" | tr '\n' ' ')
          
          echo "âœ… Current run artifacts: $CURRENT_ARTIFACT_IDS"
          echo ""
          
          # Get ALL 'github-pages' artifacts from repository
          ALL_ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[] | select(.name == "github-pages") | {id: .id, created_at: .created_at}' 2>/dev/null || echo "[]")
          
          if [ -z "$ALL_ARTIFACTS" ] || [ "$ALL_ARTIFACTS" = "[]" ]; then
            echo "âœ… No artifacts found in repository"
          else
            echo "ğŸ“‹ All 'github-pages' artifacts in repository:"
            echo "$ALL_ARTIFACTS" | jq -r '.[] | "  - ID: \(.id), Created: \(.created_at)"' 2>/dev/null || echo "$ALL_ARTIFACTS"
            echo ""
            
            # Delete artifacts that are NOT in the current run's artifact list
            DELETED_COUNT=0
            echo "$ALL_ARTIFACTS" | jq -r '.[] | .id' 2>/dev/null | while read -r artifact_id; do
              if [ -n "$artifact_id" ]; then
                # Check if this artifact is from current run
                IS_CURRENT_RUN=false
                for current_id in $CURRENT_ARTIFACT_IDS; do
                  if [ "$artifact_id" = "$current_id" ]; then
                    IS_CURRENT_RUN=true
                    break
                  fi
                done
                
                if [ "$IS_CURRENT_RUN" = "false" ]; then
                  echo "  ğŸ—‘ï¸  Deleting old artifact ID: $artifact_id"
                  if gh api repos/${{ github.repository }}/actions/artifacts/$artifact_id -X DELETE 2>/dev/null; then
                    DELETED_COUNT=$((DELETED_COUNT+1))
                    echo "    âœ… Deleted successfully"
                  else
                    echo "    âš ï¸  Could not delete (may already be deleted or expired)"
                  fi
                else
                  echo "  âœ… Keeping current run artifact ID: $artifact_id"
                fi
              fi
            done
            
            echo ""
            if [ "$DELETED_COUNT" -gt "0" ]; then
              echo "âœ… Cleaned up $DELETED_COUNT old artifact(s) from previous runs"
            else
              echo "âœ… No old artifacts to clean up"
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
          
      - name: Verify current run artifact
        run: |
          echo "ğŸ” Verifying 'github-pages' artifact in current workflow run..."
          echo "ğŸ“Š Workflow Run ID: ${{ github.run_id }}"
          echo ""
          
          # Get artifacts from THIS specific workflow run only
          ARTIFACTS_JSON=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts 2>/dev/null || echo '{"artifacts":[]}')
          ARTIFACT_COUNT=$(echo "$ARTIFACTS_JSON" | jq '[.artifacts[] | select(.name == "github-pages")] | length' 2>/dev/null || echo "0")
          
          echo "ğŸ“¦ Found $ARTIFACT_COUNT 'github-pages' artifact(s) in current run"
          echo ""
          
          if [ "$ARTIFACT_COUNT" -eq "0" ]; then
            echo "âŒ ERROR: No 'github-pages' artifact found in current run!"
            echo "   This means the build job did not upload the artifact successfully."
            echo "   Check the 'build' job logs for errors."
            exit 1
          elif [ "$ARTIFACT_COUNT" -gt "1" ]; then
            echo "âŒ ERROR: Multiple artifacts named 'github-pages' found in current run (count: $ARTIFACT_COUNT)"
            echo ""
            echo "ğŸ“‹ Artifact details:"
            echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name == "github-pages") | "  - ID: \(.id), Created: \(.created_at), Size: \(.size_in_bytes) bytes"' 2>/dev/null || echo "  (Could not parse artifact details)"
            echo ""
            echo "âš ï¸  This should not happen - the cleanup step should have prevented this."
            echo "   Please check the 'Clean up old artifacts' step logs above."
            exit 1
          else
            ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name == "github-pages") | .id' 2>/dev/null || echo "")
            ARTIFACT_SIZE=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name == "github-pages") | .size_in_bytes' 2>/dev/null || echo "unknown")
            echo "âœ… Found exactly one 'github-pages' artifact in current run"
            echo "   - ID: $ARTIFACT_ID"
            echo "   - Size: $ARTIFACT_SIZE bytes"
            echo "âœ… Ready for deployment"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment status
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ Your site is now available at: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ“¦ Deployed files from dist folder:"
          echo "  âœ… index.html"
          echo "  âœ… assets/ (JS, CSS, fonts)"
          echo "  âœ… img/ (profile, background)"
          echo "  âœ… data/ (portfolio data)"
          echo "  âœ… 404.html (SPA routing)"
          echo "  âœ… sitemap.xml (if present)"
          echo "  âœ… robots.txt (if present)"
          echo "  âœ… _headers (security, if present)"
          echo ""
          echo "ğŸ¨ Component System:"
          echo "  âœ… Design tokens"
          echo "  âœ… UI components"
          echo "  âœ… Optimized production build"
          echo ""
          echo "â±ï¸  Note: It may take a few minutes for changes to appear on GitHub Pages."
